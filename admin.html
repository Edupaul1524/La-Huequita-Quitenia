<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin · La Huequita Quiteña</title>
  <style>
    :root{--bg:#07070c;--card:#0f0f18;--text:#f5f5f5;--muted:#a0a0b5;--b:#262637;--p:#00ff7f}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui;background:radial-gradient(circle at top,#141427 0,#030308 55%,#000 100%);color:var(--text);min-height:100vh}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .box{background:linear-gradient(145deg,#0f0f18,#141427);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;box-shadow:0 18px 40px rgba(0,0,0,.75)}
    h1{letter-spacing:.10em;text-transform:uppercase;font-size:16px;margin-bottom:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:720px){.row{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.08em;text-transform:uppercase;display:block;margin:10px 0 6px}
    input,select,textarea{
      width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.10);
      background:#0b0b12;color:var(--text);outline:none
    }
    textarea{min-height:90px;resize:vertical}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:none;cursor:pointer;border-radius:999px;padding:12px 14px;
      font-weight:1000;letter-spacing:.10em;text-transform:uppercase;font-size:11px
    }
    .primary{background:var(--p);color:#041006;box-shadow:0 0 16px rgba(0,255,127,.35)}
    .ghost{background:transparent;border:1px dashed rgba(255,255,255,.18);color:var(--muted)}
    .msg{margin-top:10px;color:var(--muted);font-weight:700;font-size:13px}
    .list{margin-top:14px;display:grid;gap:10px}
    .item{border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px;background:rgba(255,255,255,.03)}
    .item b{font-size:13px}
    .item small{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="box" id="authBox">
      <h1>Admin · Login</h1>
      <label>Email</label>
      <input id="email" type="email" placeholder="tu correo admin" />
      <label>Contraseña</label>
      <input id="pass" type="password" placeholder="••••••••" />
      <div class="btns">
        <button class="primary" id="btnLogin">Entrar</button>
        <button class="ghost" id="btnLogout" style="display:none">Salir</button>
      </div>
      <div class="msg" id="authMsg"></div>
    </div>

    <div style="height:14px"></div>

    <div class="box" id="panelBox" style="display:none">
      <h1>Panel de productos</h1>

      <div class="row">
        <div>
          <label>Categoría (existente)</label>
          <select id="categorySelect"></select>

          <label>o crear nueva categoría</label>
          <input id="newCategory" placeholder="Ej: RON" />
          <div class="btns">
            <button class="ghost" id="btnCreateCategory">Crear categoría</button>
          </div>
        </div>

        <div>
          <label>Imagen (se sube a Storage)</label>
          <input id="imgFile" type="file" accept="image/*" />
          <div class="msg">Bucket: <b>product-images</b> (public)</div>
        </div>
      </div>

      <label>Nombre del producto</label>
      <input id="name" placeholder="Ej: 100 FUEGOS 750ML" />

      <label>Descripción (comercial, corta)</label>
      <textarea id="desc" placeholder="Ej: Ron intenso, ideal para reuniones."></textarea>

      <div class="row">
        <div>
          <label>Precio Pusuquí</label>
          <input id="pusuqui" type="number" step="0.01" placeholder="0.00" />
        </div>
        <div>
          <label>Precio Pomasquí</label>
          <input id="pomasqui" type="number" step="0.01" placeholder="0.00" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Precio Carcelén</label>
          <input id="carcelen" type="number" step="0.01" placeholder="0.00" />
        </div>
        <div>
          <label>Activo</label>
          <select id="active">
            <option value="true">Sí</option>
            <option value="false">No</option>
          </select>
        </div>
      </div>

      <div class="btns">
        <button class="primary" id="btnSave">Guardar producto</button>
        <button class="ghost" id="btnReload">Recargar listas</button>
      </div>
      <div class="msg" id="msg"></div>

      <div class="list" id="list"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://ekngesaavlonwdpiqlwq.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_zRYZjGHaGfWZuvedoJQyCw_LuEgk7r0";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Auth
    const authBox = document.getElementById("authBox");
    const panelBox = document.getElementById("panelBox");
    const email = document.getElementById("email");
    const pass = document.getElementById("pass");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const authMsg = document.getElementById("authMsg");

    // Panel
    const categorySelect = document.getElementById("categorySelect");
    const newCategory = document.getElementById("newCategory");
    const btnCreateCategory = document.getElementById("btnCreateCategory");

    const imgFile = document.getElementById("imgFile");
    const name = document.getElementById("name");
    const desc = document.getElementById("desc");
    const pusuqui = document.getElementById("pusuqui");
    const pomasqui = document.getElementById("pomasqui");
    const carcelen = document.getElementById("carcelen");
    const active = document.getElementById("active");
    const btnSave = document.getElementById("btnSave");
    const btnReload = document.getElementById("btnReload");
    const msg = document.getElementById("msg");
    const list = document.getElementById("list");

    function setAuthUI(isAuthed){
      panelBox.style.display = isAuthed ? "block" : "none";
      btnLogout.style.display = isAuthed ? "inline-flex" : "none";
      btnLogin.style.display = isAuthed ? "none" : "inline-flex";
      authMsg.textContent = isAuthed ? "Sesión activa ✅" : "";
    }

    btnLogin.onclick = async () => {
      authMsg.textContent = "Entrando…";
      const { error } = await supabase.auth.signInWithPassword({
        email: email.value.trim(),
        password: pass.value
      });
      if (error){ authMsg.textContent = error.message; return; }
      setAuthUI(true);
      await reloadAll();
    };

    btnLogout.onclick = async () => {
      await supabase.auth.signOut();
      setAuthUI(false);
      authMsg.textContent = "Sesión cerrada.";
    };

    async function loadCategories(){
      const { data, error } = await supabase.from("categories").select("id,name").order("name");
      if (error) throw error;
      categorySelect.innerHTML = "";
      (data||[]).forEach(c=>{
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        categorySelect.appendChild(opt);
      });
    }

    btnCreateCategory.onclick = async () => {
      const n = newCategory.value.trim();
      if (!n) return alert("Escribe el nombre de la categoría.");
      msg.textContent = "Creando categoría…";
      const { error } = await supabase.from("categories").insert({ name: n.toUpperCase() });
      if (error){ msg.textContent = error.message; return; }
      newCategory.value = "";
      msg.textContent = "Categoría creada ✅";
      await loadCategories();
    };

    async function uploadImage(file){
      if (!file) return null;

      const ext = file.name.split(".").pop();
      const safeBase = file.name
        .replace(/\.[^/.]+$/, "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g,"-")
        .replace(/[^a-z0-9\-]/g,"");

      const path = `general/${safeBase}-${Date.now()}.${ext}`;

      const { error } = await supabase.storage
        .from("product-images")
        .upload(path, file, { upsert: true });

      if (error) throw error;
      return path;
    }

    async function upsertPrices(product_id, prices){
      // prices: {PUSUQUI:1, POMASQUI:2, CARCELEN:3}
      const rows = Object.entries(prices).map(([branch, price]) => ({
        product_id, branch, price
      }));

      const { error } = await supabase.from("product_prices").upsert(rows);
      if (error) throw error;
    }

    btnSave.onclick = async () => {
      msg.textContent = "Guardando…";
      try{
        const n = name.value.trim();
        if (!n) return alert("Falta nombre del producto.");

        const category_id = categorySelect.value;
        if (!category_id) return alert("Falta categoría.");

        const file = imgFile.files?.[0] || null;
        const image_path = await uploadImage(file);

        const { data, error } = await supabase
          .from("products")
          .insert({
            name: n,
            description: desc.value.trim(),
            category_id,
            image_path,
            is_active: active.value === "true"
          })
          .select("id")
          .single();

        if (error) throw error;

        await upsertPrices(data.id, {
          PUSUQUI: Number(pusuqui.value || 0),
          POMASQUI: Number(pomasqui.value || 0),
          CARCELEN: Number(carcelen.value || 0),
        });

        msg.textContent = "Producto creado ✅";
        // limpiar
        name.value=""; desc.value=""; pusuqui.value=""; pomasqui.value=""; carcelen.value="";
        imgFile.value = "";
        await loadRecent();
      }catch(e){
        console.error(e);
        msg.textContent = e.message || "Error guardando";
        alert(msg.textContent);
      }
    };

    async function loadRecent(){
      const { data, error } = await supabase
        .from("products")
        .select("id,name,created_at,categories:category_id(name)")
        .order("created_at", { ascending:false })
        .limit(15);

      if (error) throw error;
      list.innerHTML = "";
      (data||[]).forEach(p=>{
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `<b>${p.name}</b><br><small>${p.categories?.name || ""} · ${new Date(p.created_at).toLocaleString()}</small>`;
        list.appendChild(div);
      });
    }

    async function reloadAll(){
      msg.textContent = "Cargando panel…";
      await loadCategories();
      await loadRecent();
      msg.textContent = "Listo ✅";
    }

    btnReload.onclick = reloadAll;

    // Init: si ya hay sesión
    const { data: { session } } = await supabase.auth.getSession();
    setAuthUI(!!session);
    if (session) await reloadAll();
  </script>
</body>
</html>


