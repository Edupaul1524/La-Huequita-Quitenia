<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>La Huequita Quite√±a ¬∑ Cat√°logo</title>
  <style>
    :root{
      --bg:#050509;
      --panel:#0d0d15;
      --card:#111119;
      --card2:#151525;
      --text:#f5f5f5;
      --muted:#a0a0b5;
      --border:#262637;
      --primary:#00ff7f;
      --primarySoft:rgba(0,255,127,.10);
      --danger:#ff4b5c;
      --shadow:0 14px 34px rgba(0,0,0,.75);
      --r:16px;
      --pill:999px;
      --max:1280px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
      background:radial-gradient(circle at top,#141427 0,#030308 55%,#000 100%);
      color:var(--text);
      min-height:100vh;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:var(--max);margin:0 auto;padding:14px 14px 40px}
    .topbar{
      position:sticky;top:10px;z-index:40;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 14px;border-radius:var(--pill);
      background:linear-gradient(135deg,#0f0f18,#15152a);
      border:1px solid rgba(255,255,255,.06);
      box-shadow:var(--shadow);
      backdrop-filter:blur(14px);
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{
      width:40px;height:40px;border-radius:50%;
      background:radial-gradient(circle at 30% 0,var(--primary),#007a3e 55%,#020208 100%);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;letter-spacing:.06em;
      box-shadow:0 0 20px rgba(0,255,127,.35);
      flex:0 0 auto;
    }
    .title{display:flex;flex-direction:column;gap:2px;min-width:0}
    .title b{font-size:14px;letter-spacing:.12em;text-transform:uppercase}
    .title span{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .actions{display:flex;align-items:center;gap:8px;flex:0 0 auto}
    .pillbtn{
      border:none;cursor:pointer;
      border-radius:var(--pill);
      padding:8px 12px;
      font-size:11px;font-weight:800;
      letter-spacing:.10em;text-transform:uppercase;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      color:var(--text);
      display:inline-flex;align-items:center;gap:8px;
    }
    .pillbtn.primary{
      color:#041006;
      background:radial-gradient(circle at 0 0,var(--primary),#01874a 60%,#020208);
      border-color:rgba(0,255,127,.55);
      box-shadow:0 0 18px rgba(0,255,127,.45);
    }
    .badge{
      background:var(--danger);
      color:#fff;font-size:10px;
      padding:2px 6px;border-radius:999px;
    }

    .toolbar{
      margin:14px 0 12px;
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:var(--pill);
      background:rgba(0,255,127,.07);
      border:1px solid rgba(0,255,127,.30);
      color:var(--primary);
      font-size:12px;font-weight:700;
    }
    .chip select{
      background:transparent;border:none;outline:none;
      color:var(--text);font-weight:700;font-size:12px;
    }
    .search{flex:1;min-width:210px;position:relative}
    .search input{
      width:100%;padding:12px 12px 12px 34px;
      border-radius:var(--pill);
      background:rgba(4,4,12,.9);
      border:1px solid var(--border);
      color:var(--text);outline:none;
    }
    .search .icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);margin:6px 0 12px}

    /* layout */
    .layout{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:14px;
      align-items:start;
    }
    .panel{
      background:linear-gradient(180deg,#0b0b12,#07070c);
      border:1px solid rgba(255,255,255,.06);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panel .ph{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .panel .ph b{letter-spacing:.12em;text-transform:uppercase;font-size:12px}
    .panel .pc{padding:10px}
    .catlist{display:flex;flex-direction:column;gap:8px}
    .cat{
      padding:10px 10px;border-radius:12px;cursor:pointer;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:800;font-size:12px;
      letter-spacing:.06em;text-transform:uppercase;
      transition:.15s;
    }
    .cat:hover{border-color:rgba(0,255,127,.35);color:var(--text)}
    .cat.active{
      background:var(--primarySoft);
      border-color:rgba(0,255,127,.65);
      color:var(--primary);
      box-shadow:0 0 14px rgba(0,255,127,.25);
    }

    /* products */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(210px,1fr));
      gap:14px;
      padding:12px;
    }
    .card{
      border-radius:16px;
      background:linear-gradient(145deg,var(--card),var(--card2));
      border:1px solid rgba(255,255,255,.06);
      box-shadow:var(--shadow);
      padding:10px;
      display:flex;flex-direction:column;gap:8px;
      min-height:320px;
    }
    .imgwrap{
      height:160px;border-radius:14px;
      background:rgba(0,0,0,.25);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .imgwrap img{
      max-height:150px;object-fit:contain;
      filter:drop-shadow(0 10px 18px rgba(0,0,0,.8));
    }
    .name{font-weight:900;font-size:13px;letter-spacing:.02em}
    .desc{font-size:12px;color:var(--muted);line-height:1.35;min-height:44px}
    .meta{
      display:flex;align-items:flex-end;justify-content:space-between;gap:8px;
      margin-top:auto;
      padding-top:6px;
      border-top:1px solid rgba(255,255,255,.06);
    }
    .price{font-size:16px;font-weight:1000}
    .price small{display:block;font-size:11px;color:var(--muted);font-weight:700}
    .note{font-size:10px;color:var(--muted);text-align:right;line-height:1.25}
    .btnrow{display:flex;gap:8px;margin-top:8px}
    .btn{
      flex:1;border:none;cursor:pointer;border-radius:var(--pill);
      padding:10px 10px;font-size:11px;font-weight:900;
      letter-spacing:.10em;text-transform:uppercase;
      transition:.15s;
    }
    .btn.buy{
      background:radial-gradient(circle at 0 0,var(--primary),#01874a 60%,#020208);
      color:#031006;
      box-shadow:0 0 16px rgba(0,255,127,.45);
    }
    .btn.buy:hover{transform:translateY(-1px);box-shadow:0 0 22px rgba(0,255,127,.75)}
    .btn.ghost{
      background:transparent;border:1px dashed rgba(255,255,255,.18);
      color:var(--muted);
    }
    .btn.ghost:hover{border-style:solid;color:var(--primary);border-color:rgba(0,255,127,.45)}

    /* footer */
    footer{
      margin-top:14px;padding:14px 6px;
      color:var(--muted);font-size:11px;text-align:center;
      opacity:.9;
    }

    /* age modal */
    #ageModal{
      position:fixed;inset:0;z-index:9999;
      background:rgba(0,0,0,.78);
      display:flex;align-items:center;justify-content:center;
      backdrop-filter:blur(6px);
    }
    .ageBox{
      width:min(520px,92vw);
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.16);
      box-shadow:0 0 40px rgba(0,0,0,.85);
      background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,.85));
    }
    .ageHero{
      padding:34px 18px 28px;
      background:
        radial-gradient(circle at 20% 0, rgba(0,255,127,.28), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(0,255,127,.18), transparent 55%),
        linear-gradient(135deg, rgba(0,0,0,.35), rgba(0,0,0,.85));
    }
    .ageHero h1{font-size:34px;letter-spacing:.10em;text-align:center}
    .ageHero h1 span{color:var(--primary);text-shadow:0 0 16px rgba(0,255,127,.6)}
    .ageHero p{margin-top:8px;text-align:center;color:var(--muted);font-weight:700}
    .ageBody{padding:16px 18px 18px;background:#08080d}
    .ageRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
    .ageRow select{
      width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:#0b0b12;color:var(--text);outline:none;font-weight:800
    }
    .ageBtns{display:flex;gap:10px;margin-top:12px}
    .ageBtns button{
      flex:1;padding:12px;border-radius:12px;border:none;cursor:pointer;
      font-weight:1000;letter-spacing:.08em;text-transform:uppercase;
    }
    .no{background:#2a2a33;color:#fff}
    .yes{background:var(--primary);color:#031006;box-shadow:0 0 18px rgba(0,255,127,.45)}
    @media (max-width: 880px){
      .layout{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">HQ</div>
        <div class="title">
          <b>La Huequita Quite√±a</b>
          <span>Licores ¬∑ Quito ¬∑ 17h00 a 05h00</span>
        </div>
      </div>
      <div class="actions">
        <button class="pillbtn primary" id="btnWhatsapp">üü¢ Pedir</button>
        <button class="pillbtn" id="btnCart">üõí Carrito <span class="badge" id="cartCount">0</span></button>
      </div>
    </div>

    <div class="toolbar">
      <div class="chip">üìç Sucursal
        <select id="branchSelect">
          <option value="PUSUQUI">Pusuqu√≠</option>
          <option value="POMASQUI">Pomasqu√≠</option>
          <option value="CARCELEN">Carcel√©n</option>
        </select>
      </div>
      <div class="search">
        <span class="icon">üîé</span>
        <input id="searchInput" placeholder="Buscar por nombre o categor√≠a..." />
      </div>
    </div>

    <div class="hint" id="statusLine">Cargando cat√°logo‚Ä¶</div>

    <div class="layout">
      <aside class="panel">
        <div class="ph">
          <b>Categor√≠as</b>
          <span style="color:var(--muted);font-size:11px;font-weight:800" id="catCount"></span>
        </div>
        <div class="pc">
          <div class="catlist" id="catList"></div>
        </div>
      </aside>

      <main class="panel">
        <div class="ph">
          <b id="mainTitle">Productos</b>
          <span style="color:var(--muted);font-size:11px;font-weight:800" id="prodCount"></span>
        </div>
        <div class="grid" id="grid"></div>
      </main>
    </div>

    <footer>¬© <span id="year"></span> La Huequita Quite√±a ¬∑ Consumo responsable 18+</footer>
  </div>

  <!-- MODAL +18 -->
  <div id="ageModal">
    <div class="ageBox">
      <div class="ageHero">
        <h1><span>LA HUEQUITA</span></h1>
        <p>Confirma que eres mayor de edad para ver el cat√°logo.</p>
      </div>
      <div class="ageBody">
        <div style="font-weight:1000;letter-spacing:.10em;text-transform:uppercase;font-size:12px;color:var(--muted);text-align:center">Selecciona tu sucursal</div>
        <div class="ageRow">
          <select id="ageBranch">
            <option value="PUSUQUI">La Huequita ‚Äì Pusuqu√≠</option>
            <option value="POMASQUI">La Huequita ‚Äì Pomasqu√≠</option>
            <option value="CARCELEN">La Huequita ‚Äì Carcel√©n</option>
          </select>
        </div>
        <div style="text-align:center;margin-top:10px;font-size:16px;font-weight:1000">¬øEres mayor de edad?</div>
        <div class="ageBtns">
          <button class="no" id="btnNo">NO</button>
          <button class="yes" id="btnYes">S√ç, SOY MAYOR DE 18</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ======= PON AQU√ç TUS DATOS =======
    const SUPABASE_URL = "https://ekngesaavlonwdpiqlwq.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_zRYZjGHaGfWZuvedoJQyCw_LuEgk7r0";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const WHATSAPP_NUMBER = "593982230393";

    // DOM
    const yearEl = document.getElementById("year");
    const statusLine = document.getElementById("statusLine");
    const branchSelect = document.getElementById("branchSelect");
    const searchInput = document.getElementById("searchInput");
    const catList = document.getElementById("catList");
    const grid = document.getElementById("grid");
    const mainTitle = document.getElementById("mainTitle");
    const catCount = document.getElementById("catCount");
    const prodCount = document.getElementById("prodCount");

    const ageModal = document.getElementById("ageModal");
    const ageBranch = document.getElementById("ageBranch");
    const btnYes = document.getElementById("btnYes");
    const btnNo = document.getElementById("btnNo");

    const btnWhatsapp = document.getElementById("btnWhatsapp");
    const btnCart = document.getElementById("btnCart");

    // State
    let activeBranch = localStorage.getItem("huequita_branch") || "PUSUQUI";
    let activeCategoryId = "ALL";
    let categories = [];
    let products = []; // normalizados
    let search = "";

    yearEl.textContent = new Date().getFullYear();
    branchSelect.value = activeBranch;
    ageBranch.value = activeBranch;

    function money(n){
      return (n ?? 0).toFixed(2);
    }
    function openWhatsapp(text){
      const msg = encodeURIComponent(text);
      window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`, "_blank");
    }
    btnWhatsapp.onclick = () => openWhatsapp("Hola, vengo de la web de La Huequita Quite√±a y quiero hacer un pedido üçæ");
    btnCart.onclick = () => alert("Carrito en desarrollo. Por ahora los pedidos se gestionan por WhatsApp üíö");

    // ======= Age modal (siempre en cada recarga, como pediste) =======
    btnNo.onclick = () => {
      alert("Lo sentimos, debes ser mayor de edad para ingresar üçæ");
      window.location.href = "https://google.com";
    };
    btnYes.onclick = async () => {
      activeBranch = ageBranch.value;
      localStorage.setItem("huequita_branch", activeBranch);
      branchSelect.value = activeBranch;
      ageModal.style.display = "none";
      await loadAll();
    };

    branchSelect.addEventListener("change", async () => {
      activeBranch = branchSelect.value;
      localStorage.setItem("huequita_branch", activeBranch);
      await loadAll();
    });

    searchInput.addEventListener("input", () => {
      search = (searchInput.value || "").trim().toLowerCase();
      render();
    });

    // ======= DATA =======
    async function fetchCategories(){
      const { data, error } = await supabase
        .from("categories")
        .select("id,name")
        .order("name", { ascending: true });

      if (error) throw error;
      return data || [];
    }

    async function fetchProducts(){
      // Traemos productos activos + category + precios
      const { data, error } = await supabase
        .from("products")
        .select(`
          id,name,description,image_path,is_active,
          categories:category_id ( id,name ),
          product_prices ( branch, price )
        `)
        .eq("is_active", true)
        .order("name", { ascending: true });

      if (error) throw error;

      // Normalizar: precio por sucursal
      return (data || []).map(p => {
        const priceRow = (p.product_prices || []).find(x => x.branch === activeBranch);
        const price = priceRow ? Number(priceRow.price) : null;

        const publicUrl = p.image_path
          ? supabase.storage.from("product-images").getPublicUrl(p.image_path).data.publicUrl
          : "";

        return {
          id: p.id,
          name: p.name,
          description: p.description || "",
          category_id: p.categories?.id,
          category_name: p.categories?.name || "OTROS",
          price,
          image_url: publicUrl
        };
      });
    }

    async function loadAll(){
      try{
        statusLine.textContent = "Cargando categor√≠as y productos‚Ä¶";
        categories = await fetchCategories();
        products = await fetchProducts();

        // default category
        if (activeCategoryId !== "ALL" && !categories.some(c => c.id === activeCategoryId)){
          activeCategoryId = "ALL";
        }

        statusLine.textContent = `Listo ‚úÖ Sucursal: ${activeBranch}`;
        renderCategories();
        render();
      }catch(e){
        console.error(e);
        statusLine.textContent = "Error cargando cat√°logo. Revisa consola (F12).";
        alert("Error cargando cat√°logo. Abre F12 ‚Üí Console para ver el detalle.");
      }
    }

    // ======= UI =======
    function renderCategories(){
      catList.innerHTML = "";

      const allBtn = document.createElement("div");
      allBtn.className = "cat" + (activeCategoryId === "ALL" ? " active" : "");
      allBtn.textContent = "TODOS";
      allBtn.onclick = () => { activeCategoryId = "ALL"; renderCategories(); render(); };
      catList.appendChild(allBtn);

      categories.forEach(c => {
        const btn = document.createElement("div");
        btn.className = "cat" + (activeCategoryId === c.id ? " active" : "");
        btn.textContent = c.name;
        btn.onclick = () => { activeCategoryId = c.id; renderCategories(); render(); };
        catList.appendChild(btn);
      });

      catCount.textContent = `${categories.length} categor√≠as`;
    }

    function render(){
      // filtrar
      let filtered = products.filter(p => {
        const byCat = (activeCategoryId === "ALL") || (p.category_id === activeCategoryId);
        const bySearch = !search ||
          p.name.toLowerCase().includes(search) ||
          (p.category_name || "").toLowerCase().includes(search);
        return byCat && bySearch;
      });

      mainTitle.textContent = (activeCategoryId === "ALL")
        ? "Productos"
        : (categories.find(c => c.id === activeCategoryId)?.name || "Productos");

      prodCount.textContent = `${filtered.length} items`;

      grid.innerHTML = "";
      if (!filtered.length){
        grid.innerHTML = `<div style="padding:14px;color:var(--muted);font-weight:800">
          No hay productos para este filtro/b√∫squeda en esta sucursal.
        </div>`;
        return;
      }

      filtered.forEach(p => {
        const card = document.createElement("div");
        card.className = "card";

        const img = p.image_url
          ? `<img src="${p.image_url}" alt="${p.name}" loading="lazy" />`
          : `<div style="color:var(--muted);font-weight:900">SIN IMAGEN</div>`;

        const priceTxt = (p.price === null) ? "No disponible" : `$ ${money(p.price)}`;

        card.innerHTML = `
          <div class="imgwrap">${img}</div>
          <div class="name">${p.name}</div>
          <div class="desc">${p.description || "Producto disponible en tienda. Pregunta por stock y delivery."}</div>

          <div class="meta">
            <div class="price">
              ${priceTxt}
              <small>Precio en ${activeBranch}</small>
            </div>
            <div class="note">
              Delivery (app/taxi) no incluido.<br/>
              Tarjeta puede tener recargo.
            </div>
          </div>

          <div class="btnrow">
            <button class="btn buy">Pedir</button>
            <button class="btn ghost">Detalle</button>
          </div>
        `;

        const [btnBuy, btnDetail] = card.querySelectorAll("button");
        btnBuy.onclick = () => {
          openWhatsapp(
            `Hola, quiero hacer un pedido en *La Huequita Quite√±a* (${activeBranch}):\n` +
            `‚Ä¢ Producto: ${p.name}\n` +
            `‚Ä¢ Precio: ${priceTxt}\n` +
            `¬øMe ayudas con disponibilidad y delivery?`
          );
        };
        btnDetail.onclick = () => {
          alert(
            `Producto: ${p.name}\n` +
            `Categor√≠a: ${p.category_name}\n` +
            `Sucursal: ${activeBranch}\n` +
            `Precio: ${priceTxt}\n\n` +
            `${p.description || ""}`
          );
        };

        grid.appendChild(card);
      });
    }

    // IMPORTANTE: por tu requerimiento, el modal aparece siempre
    // as√≠ que NO llamamos loadAll() hasta que confirme.
  </script>
</body>
</html>



